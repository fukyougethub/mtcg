<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Comp Generator â€” Full Fixed</title>
  <link rel="icon" href="data:,">
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;background:#f7f7fb;color:#111;margin:0;padding:20px}
    .container{max-width:1000px;margin:0 auto;background:#fff;border-radius:12px;padding:18px;box-shadow:0 6px 30px rgba(18,24,40,0.06)}
    h1{font-size:18px;margin:0 0 12px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
    label{display:flex;align-items:center;gap:8px;padding:6px;border-radius:6px}
    .controls{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
    button{padding:8px 12px;border-radius:8px;border:0;background:#2563eb;color:white;cursor:pointer}
    button.secondary{background:#6b7280}
    .output{margin-top:12px;padding:10px;background:#f3f4f6;border-radius:8px;white-space:pre-wrap;font-family:monospace}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center}
    .modal .panel{background:white;padding:16px;border-radius:8px;max-width:560px;width:100%}
    .small{font-size:13px;color:#374151}
    input[type=text],input[type=number],select{width:100%;padding:8px;border-radius:6px;border:1px solid #e5e7eb}
    .hint{font-size:12px;color:#6b7280}
  </style>
</head>
<body>
<div class="container">
<h1>Pick troops for the rating (Trait Dummy adds 1 slot)</h1>
<div id="pieces" class="grid"></div>
<div style="margin-top:10px;">
  <label for="ruler">Select Ruler:</label>
  <select id="ruler">
    <option>Royale King</option>
    <option>Spirit Empress</option>
    <option>Goblin Queen</option>
    <option>Elixir Loong</option>
  </select>
</div>
<div style="margin-top:10px;">
  <label for="modifier">Select Modifier:</label>
  <select id="modifier">
    <option value="Default">Default</option>
    <option value="Champion Star">Champion Star</option>
    <option value="Endurance Training">Endurance Training</option>
    <option value="Fighting Fever">Fighting Fever</option>
    <option value="You're Mine">You're Mine / Echo Bench / Ascension</option>
    <option value="Last Stand">Last Stand</option>
    <option value="Trait Dummy">Trait Dummy (forced extra slot + dummy)</option>
  </select>
</div>
<div id="traitDummySettings" style="display:none; margin-top:10px;">
  <label for="dummyGroup1">Trait Dummy - Group 1:</label>
  <select id="dummyGroup1"></select>
  <label for="dummyGroup2" style="margin-top:6px;">Trait Dummy - Group 2:</label>
  <select id="dummyGroup2"></select>
  <div class="hint">When Trait Dummy is active we auto-add a TANK dummy with these two trait values and increase team capacity by +1 (dummy occupies that extra slot).</div>
</div>
<div class="controls">
  <button id="rateBtn">Rate my team</button>
  <button id="genBtn">Generate a good team</button>
  <button id="customBtn" class="secondary">Custom Team Finder</button>
  <button id="bestBtn" class="secondary">Find BEST possible team</button>
  <div style="margin-left:auto" class="hint">Pickable pieces: <span id="pickLimit">6</span> (shows +1 if Trait Dummy)</div>
</div>
<div id="out" class="output">Results will appear here.</div>
</div>

<div id="modal" class="modal" style="display:none">
  <div class="panel">
    <h3>Custom Team Options</h3>
    <label class="small">Minimum Score:</label>
    <input id="minScore" type="number" step="0.1" value="10.0" />
    <label class="small" style="margin-top:8px">Required Troops (comma separated):</label>
    <input id="reqTroops" type="text" placeholder="e.g. PRINCE, WIZARD" />
    <label class="small" style="margin-top:8px">Required Groups (format: GROUP:count, comma separated):</label>
    <input id="reqGroups" type="text" placeholder="e.g. NOBLE:2, UNDEAD:1" />
    <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
      <button id="findCustom">Find Team</button>
      <button id="closeModal" class="secondary">Close</button>
    </div>
  </div>
</div>

<script>
/*************************************************************************
* Full implementation
*************************************************************************/
function resetUI() {
  document.querySelectorAll('#pieces input[type=checkbox]').forEach(cb=>cb.checked=false);
  if(PIECES["_DUMMY_"]) delete PIECES["_DUMMY_"];
  modifierSelect.value='Default';
  traitDummySettings.style.display='none';
  pickLimitEl.textContent=basePickLimit;
  modal.style.display='none';
  out.textContent='Results will appear here.';
}
function safeRun(fn){try{return fn();}catch(err){console.error(err);resetUI();out.textContent="Error occurred; UI reset. See console.";}}

const piecesDiv=document.getElementById('pieces');
const modifierSelect=document.getElementById('modifier');
const traitDummySettings=document.getElementById('traitDummySettings');
const dummyGroup1=document.getElementById('dummyGroup1');
const dummyGroup2=document.getElementById('dummyGroup2');
const pickLimitEl=document.getElementById('pickLimit');
const out=document.getElementById('out');
const modal=document.getElementById('modal');

const GROUPS={"NOBLE":["KNIGHT","PRINCE","PRINCESS","GOLDEN KNIGHT","MUSKETEER"],"JUGGERNAUT":["KNIGHT","VALKYRIE","GOBLIN MACHINE","SKELETON KING"],"CLAN":["ARCHER","BARBARIAN","VALKYRIE","ARCHER QUEEN"],"RANGER":["ARCHER","DART GOBLIN","PRINCESS","SKELETON DRAGONS"],"GOBLIN":["GOBLINS","SPEAR GOBLINS","DART GOBLIN","GOBLIN MACHINE"],"ASSASSIN":["GOBLINS","ROYAL GHOST","GOLDEN KNIGHT","BANDIT"],"BLASTER":["SPEAR GOBLINS","BABY DRAGON","EXECUTIONER","MUSKETEER"],"BRAWLER":["BARBARIAN","PRINCE","GIANT SKELETON","MEGA KNIGHT"],"AVENGER":["PEKKA","ELECTRO GIANT","ARCHER QUEEN","WITCH"],"ACE":["PEKKA","EXECUTIONER","MEGA KNIGHT","BANDIT"],"UNDEAD":["WITCH","GIANT SKELETON","ROYAL GHOST","SKELETON KING","SKELETON DRAGONS"],"MAGE":["WIZARD","ELECTRO WIZARD"],"FIRE":["WIZARD","BABY DRAGON"],"ELECTRIC":["ELECTRO GIANT","ELECTRO WIZARD"]};

const GROUP_RANKINGS={"NOBLE":5,"JUGGERNAUT":5,"CLAN":3,"RANGER":2,"GOBLIN":5,"ASSASSIN":1,"BLASTER":4,"BRAWLER":1,"AVENGER":3,"ACE":5,"UNDEAD":5,"MAGE":2,"FIRE":3,"ELECTRIC":2};

function getGroupMultiplier(g){return GROUP_RANKINGS[g]?GROUP_RANKINGS[g]/5:1;}

function getBonusMultiplier(b){return b===1?0.95:b===2?0.98:b===3?1.0:b===4?1.03:b===5?1.05:1.0;}

const PIECES={"KNIGHT":{"type":"TANK","group1":"NOBLE","group2":"JUGGERNAUT","bonus":1,"cost":2,"abilityamount":0},"PRINCE":{"type":"TANK","group1":"NOBLE","group2":"BRAWLER","bonus":3,"cost":3,"abilityamount":1},"PRINCESS":{"type":"ARTILLERY","group1":"NOBLE","group2":"RANGER","bonus":4,"cost":4,"abilityamount":0},"GOLDEN KNIGHT":{"type":"ASSASSIN","group1":"NOBLE","group2":"ASSASSIN","bonus":5,"cost":5,"abilityamount":1},"PEKKA":{"type":"DAMAGE DEALER","group1":"AVENGER","group2":"ACE","bonus":3,"cost":3,"abilityamount":0},"GOBLIN MACHINE":{"type":"CONTROLLER","group1":"JUGGERNAUT","group2":"GOBLIN","bonus":4,"cost":4,"abilityamount":2},"SKELETON KING":{"type":"DAMAGE DEALER","group1":"JUGGERNAUT","group2":"UNDEAD","bonus":4,"cost":5,"abilityamount":1},"ARCHER":{"type":"MARKSMEN","group1":"CLAN","group2":"RANGER","bonus":3,"cost":2,"abilityamount":0},"BARBARIAN":{"type":"CONTROLLER","group1":"CLAN","group2":"BRAWLER","bonus":2,"cost":2,"abilityamount":0},"VALKYRIE":{"type":"TANK","group1":"CLAN","group2":"JUGGERNAUT","bonus":3,"cost":3,"abilityamount":0},"ARCHER QUEEN":{"type":"MARKSMEN","group1":"CLAN","group2":"AVENGER","bonus":5,"cost":5,"abilityamount":2},"DART GOBLIN":{"type":"MARKSMEN","group1":"GOBLIN","group2":"RANGER","bonus":2,"cost":3,"abilityamount":0},"GOBLINS":{"type":"ASSASSIN","group1":"GOBLIN","group2":"ASSASSIN","bonus":2,"cost":2,"abilityamount":0},"SPEAR GOBLINS":{"type":"DAMAGE DEALER","group1":"GOBLIN","group2":"BLASTER","bonus":1,"cost":2,"abilityamount":0},"ROYAL GHOST":{"type":"ASSASSIN","group1":"ASSASSIN","group2":"UNDEAD","bonus":5,"cost":4,"abilityamount":1},"WIZARD":{"type":"ARTILLERY","group1":"FIRE","group2":"MAGE","bonus":3,"cost":2,"abilityamount":0},"EXECUTIONER":{"type":"ARTILLERY","group1":"BLASTER","group2":"ACE","bonus":3,"cost":3,"abilityamount":0},"GIANT SKELETON":{"type":"DAMAGE DEALER","group1":"BRAWLER","group2":"UNDEAD","bonus":4,"cost":3,"abilityamount":2},"MEGA KNIGHT":{"type":"TANK","group1":"BRAWLER","group2":"ACE","bonus":4,"cost":4,"abilityamount":2},"BANDIT":{"type":"ASSASSIN","group1":"ASSASSIN","group2":"ACE","bonus":4,"cost":4,"abilityamount":1},"SKELETON DRAGONS":{"type":"CONTROLLER","group1":"UNDEAD","group2":"RANGER","bonus":2,"cost":2,"abilityamount":1},"ELECTRO GIANT":{"type":"TANK","group1":"ELECTRIC","group2":"AVENGER","bonus":3,"cost":3,"abilityamount":2},"MUSKETEER":{"type":"MARKSMEN","group1":"NOBLE","group2":"BLASTER","bonus":3,"cost":3,"abilityamount":1},"BABY DRAGON":{"type":"DAMAGE DEALER","group1":"FIRE","group2":"BLASTER","bonus":4,"cost":4,"abilityamount":0},"ELECTRO WIZARD":{"type":"CONTROLLER","group1":"MAGE","group2":"ELECTRIC","bonus":5,"cost":4,"abilityamount":2},"WITCH":{"type":"CONTROLLER","group1":"UNDEAD","group2":"AVENGER","bonus":3,"cost":4,"abilityamount":2}};

const selection={};const allIds=Object.keys(PIECES);
allIds.forEach(pid=>{const lbl=document.createElement('label');const cb=document.createElement('input');cb.type='checkbox';cb.addEventListener('change',()=>selection[pid]=cb.checked?1:0);selection[pid]=0;const span=document.createElement('span');span.textContent=pid;lbl.appendChild(cb);lbl.appendChild(span);piecesDiv.appendChild(lbl);});

const groupNames=Object.keys(GROUPS);
groupNames.forEach(g=>{const o1=document.createElement('option');o1.value=g;o1.textContent=g;const o2=o1.cloneNode(true);dummyGroup1.appendChild(o1);dummyGroup2.appendChild(o2);});

const basePickLimit=6;pickLimitEl.textContent=basePickLimit;

modifierSelect.addEventListener('change',()=>{
  const isDummy=modifierSelect.value==='Trait Dummy';
  traitDummySettings.style.display=isDummy?'block':'none';
  pickLimitEl.textContent=isDummy?basePickLimit+1:basePickLimit;
});

function stagePointsForGroup(memberCount, groupSize){
  let pts=0;
  if(groupSize>=5){if(memberCount>=2) pts+=1;if(memberCount>=3) pts+=1;if(memberCount>=4) pts+=1;}
  else if(groupSize===4){if(memberCount>=2) pts+=1;if(memberCount>=3) pts+=1;if(memberCount>=4) pts+=1;}
  else if(groupSize===3){if(memberCount>=1) pts+=1;if(memberCount>=2) pts+=1;if(memberCount>=3) pts+=1;}
  else if(groupSize===2){if(memberCount>=1) pts+=1;if(memberCount>=2) pts+=1;}
  else{if(memberCount>=2) pts+=1;}
  return pts;
}

function scoreGroup(chosenIds){
  const chosen=[...chosenIds];const chosenSet=new Set(chosen);
  let dummyAdded=false;
  const modifierValue=modifierSelect.value;
  if(modifierValue==="Trait Dummy"){
    const g1=dummyGroup1.value,g2=dummyGroup2.value;
    const dummyPiece={type:"TANK",group1:g1,group2:g2,bonus:3,cost:0,abilityamount:0};
    PIECES["_DUMMY_"]=dummyPiece;chosen.push("_DUMMY_");dummyAdded=true;
  }
  const groupCounts={};for(const g of Object.keys(GROUPS)) groupCounts[g]=0;
  for(const pid of chosen){
    const piece=PIECES[pid];if(!piece) continue;
    if(piece.group1) groupCounts[piece.group1]=(groupCounts[piece.group1]||0)+1;
    if(piece.group2) groupCounts[piece.group2]=(groupCounts[piece.group2]||0)+1;
  }
  let score=0;
  for(const [gname,members] of Object.entries(GROUPS)){
    const count=groupCounts[gname]||0;
    const pts=stagePointsForGroup(count,members.length);
    score+=pts*getGroupMultiplier(gname);
  }
  const chosenTypes=new Set(chosen.map(p=>PIECES[p]&&PIECES[p].type).filter(Boolean));
  if(chosenTypes.size>1) score+=chosenTypes.size/2;
  let bonusMultiplier=1;for(const pid of chosen){const piece=PIECES[pid];if(piece&&piece.bonus) bonusMultiplier*=getBonusMultiplier(piece.bonus);}
  let flatBonusPoints=0;for(const pid of chosen){const piece=PIECES[pid];if(piece&&piece.bonusPoints) flatBonusPoints+=piece.bonusPoints;}
  const totalCost=chosen.reduce((s,p)=>s+((PIECES[p]&&PIECES[p].cost)||0),0);
  let final=score*bonusMultiplier+flatBonusPoints;

  const ruler=document.getElementById('ruler').value;
  if(ruler==="Royale King") final*=1.1;
  else if(ruler==="Spirit Empress"){if(totalCost>20) final*=1.2;}
  else if(ruler==="Goblin Queen"){const hasGoblin=chosenSet.has("GOBLINS");const hasSpear=chosenSet.has("SPEAR GOBLINS");const hasDart=chosenSet.has("DART GOBLIN");const hasMachine=chosenSet.has("GOBLIN MACHINE");if(hasGoblin&&hasSpear&&hasDart&&hasMachine) final*=1.5;else if((hasGoblin&&hasSpear)||(hasDart&&hasSpear)||(hasDart&&hasGoblin)||(hasDart&&hasSpear&&hasGoblin)) final*=1.25;}
  else if(ruler==="Elixir Loong") final*=1.05;

  if(modifierValue==='Champion Star'){if(chosen.some(pid=>PIECES[pid]&&PIECES[pid].cost===5)) final*=1.05;}
  else if(modifierValue==='Endurance Training'){const tankCount=chosen.filter(pid=>PIECES[pid]&&PIECES[pid].type==='TANK').length;if(tankCount>0) final*=Math.pow(1.01,tankCount);}
  else if(modifierValue==='Fighting Fever'){const assassinCount=chosen.filter(pid=>PIECES[pid]&&PIECES[pid].type==='ASSASSIN').length;if(assassinCount>0) final*=Math.pow(1.01,assassinCount);}
  else if(modifierValue==="You're Mine"){const costMult={2:1.0,3:1.005,4:1.01,5:1.025};for(const pid of chosen){const p=PIECES[pid];if(!p) continue;if(p.cost>=2&&p.cost<=5) final*=costMult[p.cost];if(p.abilityamount===1) final*=1.01;else if(p.abilityamount===2) final*=1.025;}}
  else if(modifierValue==="Last Stand"){const ddCount=chosen.filter(pid=>PIECES[pid]&&PIECES[pid].type==="DAMAGE DEALER").length;if(ddCount>0) final*=Math.pow(1.01,ddCount);}

  if(dummyAdded&&PIECES['_DUMMY_']) delete PIECES['_DUMMY_'];
  return {final,detail:{groupCounts,totalCost}};
}

// RATE button
document.getElementById('rateBtn').addEventListener('click',()=>safeRun(()=>{
  const chosen=Object.entries(selection).filter(([k,v])=>v===1).map(([k])=>k);
  const baseRequired=document.getElementById('ruler').value==='Elixir Loong'?7:6;
  const isDummy=modifierSelect.value==='Trait Dummy';
  const requiredRealPicks=isDummy?baseRequired-1:baseRequired;
  if(chosen.length!==requiredRealPicks){alert(`Pick exactly ${requiredRealPicks} real troops${isDummy?" (plus dummy)":"."}`);return;}
  const res=scoreGroup(chosen);
  const finalScore=res.final;
  const details=chosen.map(pid=>{if(pid==="_DUMMY_"){const d=PIECES["_DUMMY_"];return `TRAIT DUMMY: type=${d.type} Groups=(${dummyGroup1.value},${dummyGroup2.value}) Bonus=3 Cost=0`;}const p=PIECES[pid];return `${pid}: type=${p.type} Groups=(${p.group1},${p.group2}) Bonus=${p.bonus} Cost=${p.cost}`}).join('\n');
  showResult(`Team score: ${finalScore.toFixed(2)}`,details);
}));

function showResult(title,text){out.textContent=title+"\n\n"+text;}
</script>
</body>
</html>
